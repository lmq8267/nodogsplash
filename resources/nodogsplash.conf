## Nodogsplash 配置文件
## 前面两个#的表示参数说明，一个#的表示参数值 可以注释掉以启用

#################################################################
## 参数：GatewayInterface（网关接口）
## 默认值：NONE
## GatewayInterface 不是自动检测的，必须在此处手动设置。
## 将 GatewayInterface 设置为路由器上由 Nodogsplash 管理的接口。
## 通常为有线与无线局域网接口 br-lan。

GatewayInterface br0

#################################################################
## 参数：WebRoot（网页根目录）
## 默认值：/etc/storage/nodogsplash/htdocs
## 存放登录（splash.html）页面内容的本地路径。

WebRoot /etc/storage/nodogsplash/htdocs

#################################################################
## 防火墙规则集：authenticated-users（已认证用户）
## 用于控制认证后的用户访问。
## 这些规则会被插入到路由器防火墙表 filter 的 FORWARD 链开头，
## 并应用于从 GatewayInterface 接收到、来自已认证 MAC 地址、
## 且要被路由转发的数据包。
## 规则按顺序匹配，第一个匹配的规则将被应用。
## 如果规则集非空，但没有任何规则匹配，则该数据包被拒绝。
## 注意：此规则集与 preauthenticated-users 完全独立。

FirewallRuleSet authenticated-users {

## 若希望允许访问本地某个被阻止的子网（例如提供重定向页面），可显式允许，例如：
#  FirewallRule allow tcp port 80 to 192.168.254.254

## 若路由器有多个接口，且希望保持它们对 GatewayInterface 私有，可阻止这些接口的整个子网，例如：
#  FirewallRule block to 192.168.0.0/16
#  FirewallRule block to 10.0.0.0/8

## 一般情况下建议允许以下常见端口：
## 53（DNS）udp 和 tcp
## 80（HTTP）
## 443（HTTPS）
## 22（SSH）
## 示例：
#  FirewallRule allow tcp port 53	
#  FirewallRule allow udp port 53	
#  FirewallRule allow tcp port 80
#  FirewallRule allow tcp port 443
#  FirewallRule allow tcp port 22

## 若想完全开放访问，可直接
  FirewallRule allow all

## 也可以使用 ipset 管理允许或阻止的 IP 范围：
# FirewallRule allow ipset WHITELISTED_IPS
# FirewallRule allow tcp port 80 ipset WHITELISTED_IPS
}

#################################################################
## 防火墙规则集：preauthenticated-users（未认证用户）
## 控制认证前的用户访问。
## 这些规则插入到路由器 nat 表的 PREROUTING 链和 filter 表的 FORWARD 链中。
## 它们应用于来自 GatewayInterface、且未在 BlockedMACList 或 TrustedMACList 中、
## 也未通过认证的 MAC 地址的数据包。
## 按顺序匹配，第一个匹配规则生效。
## 若规则集非空，但无规则匹配，则该数据包被拒绝。
## 注意：此规则集与 authenticated-users 和 users-to-router 独立。

FirewallRuleSet preauthenticated-users {
## 若希望未认证用户解析外部 DNS（而非使用路由器自身作为 DNS 服务器），
## 可启用以下规则：
FirewallRule allow tcp port 53
FirewallRule allow udp port 53

## 若登录页不在路由器上托管（即远程页面），
## 可允许访问对应远程主机的 80 端口。
## 注意必须使用远程主机的 IP 地址：
#  FirewallRule allow tcp port 80 to 123.321.123.321
}

#################################################################
## 防火墙规则集：users-to-router（用户到路由器）
## 控制来自 GatewayInterface 的用户对路由器本身的访问。
## 这些规则会被插入到路由器防火墙表 filter 的 INPUT 链开头，
## 并应用于未在 TrustedMACList 中、且目标为路由器本身的数据包。
## 规则按顺序匹配，第一个匹配的规则将被应用。
## 若规则集非空但无匹配，数据包将被拒绝。

FirewallRuleSet users-to-router {
 ## Nodogsplash 会自动允许访问 GatewayPort（登录页服务端口），
 ## 但若你希望开放其他服务（如 DNS、DHCP），可如下设置：
    FirewallRule allow udp port 53	
    FirewallRule allow tcp port 53	
    FirewallRule allow udp port 67
 ## 若需要从 GatewayInterface 访问路由器管理端口（如 ssh、http、https），
 ## 可保持以下规则，否则可注释掉。
   FirewallRule allow tcp port 22
   FirewallRule allow tcp port 80
   FirewallRule allow tcp port 443
}

#################################################################
## EmptyRuleSetPolicy（空规则集策略）
## Nodogsplash 支持以下规则集：

## authenticated-users
## preauthenticated-users
## users-to-router
## trusted-users
## trusted-users-to-router

## 对于每个规则集，可以定义当规则集为空或缺失时的默认策略：
## allow —— 允许数据包通过
## block —— 拒绝数据包
## passthrough —— 交由现有防火墙规则处理

## 默认策略如下：
# EmptyRuleSetPolicy authenticated-users passthrough
# EmptyRuleSetPolicy preauthenticated-users block
# EmptyRuleSetPolicy users-to-router block
# EmptyRuleSetPolicy trusted-users allow
# EmptyRuleSetPolicy trusted-users-to-router allow

#################################################################
## 参数：GatewayName（网关名称）
## 默认值：Padavan
## 设置网关名称，用于在 splash 页面或 ndsctl 状态输出中显示。
## 仅作显示用途。

GatewayName Padavan

#################################################################
## 参数：GatewayAddress（网关地址）
## 默认值：自动检测
## 通常在 OpenWRT 系统上会自动检测。
## 若未检测到，可手动设置为路由器在 GatewayInterface 上的 IP 地址。
## 该地址即 Nodogsplash 内置 HTTP 服务器监听的地址。

# GatewayAddress 192.168.1.1

#################################################################
## 参数：StatusPage（状态页）
## 默认值：status.html
## 已认证的用户再次访问登录页时显示的页面。

# StatusPage status.html

#################################################################
## 参数：SplashPage（登录页）
## 默认值：login.html
## 未认证用户访问时重定向显示的页面。

# SplashPage login.html

#################################################################
## 参数：RedirectURL（认证后跳转地址）
## 默认值：无
## 通常认证后会跳转到用户最初请求的页面。
## 若设置 RedirectURL，则会强制跳转到指定 URL。

# RedirectURL http://www.example.com/

#################################################################
## 参数：GatewayPort（网关端口）
## 默认值：2050
## Nodogsplash 内置 HTTP 服务器监听 GatewayAddress 的端口。

# GatewayPort 2050

#################################################################
## 参数：MaxClients（最大客户端数）
## 默认值：20
## 同时允许连接的最大用户数（不包括 TrustedMACList 中的用户）。

  MaxClients 250

#################################################################
## 参数：SessionTimeout（会话时长）
## 默认值：0（无限制）
## 设置用户会话的持续时间（分钟）。
## 值为 0 表示无时间限制。

# SessionTimeout 0

#################################################################
## 参数：PreAuthIdleTimeout（预认证空闲超时）
## 默认值：10
## 设置未认证用户在空闲多少分钟后被自动移除。

# PreAuthIdleTimeout 10

#################################################################
## 参数：AuthIdleTimeout（已认证空闲超时）
## 默认值：120
## 设置已认证用户空闲多少分钟后自动注销。

# AuthIdleTimeout 120

#################################################################
## 参数：CheckInterval（检查间隔）
## 默认值：30
## 设置系统检查客户端超时状态的时间间隔（单位：秒）。

# CheckInterval 30

#################################################################
## #参数：MACMechanism（MAC 地址控制模式）
## 默认值：block
## 可选值：block 或 allow
## 若为 block，则 BlockedMACList 中的 MAC 被禁止认证，其余允许；
## 若为 allow，则 AllowedMACList 中的 MAC 被允许认证，其余禁止。

# MACMechanism block

#################################################################
## 参数：BlockedMACList（阻止的 MAC 地址）
## 默认值：无
## 用逗号分隔的 MAC 地址列表，这些设备将完全禁止访问 GatewayInterface。
## 仅在 MACMechanism=block 时有效。

# BlockedMACList 00:00:DE:AD:BE:EF,00:00:C0:1D:F0:0D

#################################################################
## 参数：AllowedMACList（允许的 MAC 地址）
## 默认值：无
## 用逗号分隔的 MAC 地址列表，这些设备将被允许访问 GatewayInterface。
## 仅在 MACMechanism=allow 时有效。

# AllowedMACList 00:00:12:34:56:78

#################################################################
## 参数：TrustedMACList（信任 MAC 地址）
## 默认值：无
## 这些 MAC 地址不需要认证，完全不受限制。

# TrustedMACList 00:00:CA:FE:BA:BE, 00:00:C0:01:D0:0D

#################################################################
## 参数：TrafficControl（流量控制）
## 默认值：no
## 设置为 yes 启用流量控制功能。

# TrafficControl no

#################################################################
## 参数：DownloadLimit（下载限速）
## 默认值：0（无限制）
## 启用 TrafficControl 时，设置最大下载速率（kbps）。
## 例如要限制为 384kbps：

# DownloadLimit 384

#################################################################
## 参数：UploadLimit（上传限速）
## 默认值：0（无限制）
## 启用 TrafficControl 时，设置最大上传速率（kbps）。
## 例如限制为 64kbps：

# UploadLimit 64

#################################################################
## 参数：GatewayIPRange（管理的 IP 范围）
## 默认值：0.0.0.0/0
## 限定 Nodogsplash 管理的 IP 地址范围。
## 仅处理此范围内的数据包。

# GatewayIPRange 0.0.0.0/0

#################################################################
## 参数：DebugLevel（日志详细等级）
## 默认值：1
## 0：仅错误
## 1：错误、警告、信息
## 2：较详细信息
## 3：全部调试信息

# DebugLevel 1

#################################################################
## 参数: BinAuth （认证脚本）
## 如果启用，当进行认证（请求）或取消认证时，会调用一个程序，并传入若干参数。
## 认证请求：
## $<BinAuth> auth_client <client_mac> '<username>' '<password>'

## 用户名和密码可以是空字符串，并且是 URL 编码的。
## 程序需要输出客户端认证的秒数。输出为零或负数，或者返回码不为 0，都会导致认证请求被拒绝。
## 输出还可以包含用户特定的上传和下载速度限制（单位：KBit/s）：
## <seconds> <upload> <download>

## 当进行认证或取消认证时会被调用：
## $<BinAuth> <*auth|*deauth> <incoming_bytes> <outgoing_bytes> <session_start> <session_end>
## "client_auth": 客户端通过该脚本成功认证。
## "client_deauth": 客户端通过热点页面取消认证。
## "idle_deauth": 客户端因闲置而被取消认证。
## "timeout_deauth": 客户端会话超时被取消认证。
## "ndsctl_auth": 客户端通过 ndsctl 工具手动认证。
## "ndsctl_deauth": 客户端通过 ndsctl 工具手动取消认证。
## "shutdown_deauth": Nodogsplash 终止时取消认证客户端。

## 参数 session_start 和 session_end 为自 1970 年以来的秒数，或为 0 表示未知/无限制。

# BinAuth /etc/storage/nodogsplash/myauth.sh

#################################################################
## Nodogsplash 使用特定的十六进制值来标记 iptables 处理的包，这些值作为按位掩码使用。
## 该掩码可能与其他软件包（如 mwan3、sqm 等）的要求冲突。
## 此处设置的值均以十六进制解释。

## 参数: fw_mark_authenticated
## 默认值: 30000 (0011|0000|0000|0000|0000 二进制)

# fw_mark_authenticated 30000

## 参数: fw_mark_trusted
## 默认值: 20000 (0010|0000|0000|0000|0000 二进制)

# fw_mark_trusted 20000

## 参数: fw_mark_blocked
## 默认值: 10000 (0001|0000|0000|0000|0000 二进制)

# fw_mark_blocked 10000
