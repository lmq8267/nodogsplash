<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nodogsplash 管理面板</title>
<style>
body, html {
    margin: 0; padding: 0;
    width: 100%; min-height: 100%;
    font-family: "Microsoft YaHei", "SimHei", "Arial", sans-serif;
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    color: #fff; overflow-y: auto;
}
.container {
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 20px;
    margin: 20px auto;
    max-width: 95%;
    animation: fadeIn 1.2s ease-in-out;
}
@keyframes fadeIn { from {opacity:0; transform:translateY(-20px);} to {opacity:1; transform:translateY(0);} }
h1 {
    font-size:2rem; margin-bottom:20px;
    color:#ffeb3b; text-align:center;
    text-shadow:1px 1px 5px rgba(0,0,0,0.5);
    animation:pulse 2s infinite;
}
@keyframes pulse {0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);}}
.header-flex {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
}
.client-count {
    font-size: 0.95rem;
    color: #ffeb3b;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    margin-left: 10px; 
}
.info-section {
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 12px;
    margin-top: 15px;
    font-size: 0.9rem;
}
.table-container { overflow-x:auto; }
table {
    width:100%; border-collapse:collapse; border-radius:10px; overflow:hidden; min-width:800px;
}
th, td {
    padding:8px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.85rem;
}
th { background: rgba(255,255,255,0.1); color:#ffeb3b; cursor:pointer; }
tr:nth-child(even) { background: rgba(255,255,255,0.02); }
button {
    margin:2px; padding:5px 10px; border:none; border-radius:6px;
    cursor:pointer; font-size:0.8rem; font-weight:bold;
    transition: transform 0.2s, box-shadow 0.2s;
}
button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 3px 10px rgba(0,0,0,0.3); }
.auth { background: linear-gradient(90deg,#4CAF50,#81C784); color:#fff; }
.deauth { background: linear-gradient(90deg,#FF5722,#FF8A65); color:#fff; }
.trust { background: linear-gradient(90deg,#2196F3,#64B5F6); color:#fff; }
.cancel-btn { background: linear-gradient(90deg,#f44336,#e57373); color:#fff; }
.block { background: linear-gradient(90deg,#ff9800,#FFB74D); color:#fff; }
.refresh-btn { background: linear-gradient(90deg,#9C27B0,#BA68C8); color:#fff; }
.duration-btn { background: linear-gradient(90deg,#00BCD4,#4DD0E1); color:#fff; }
.allow-btn { background: linear-gradient(90deg,#8BC34A,#AED581); color:#fff; }
.logout-btn { background: linear-gradient(90deg,#E91E63,#F06292); color:#fff; }
button:disabled { opacity:0.5; cursor:not-allowed; background-color:#ccc; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.spin { animation: spin 1s linear; }
input[type="text"], input[type="number"], input[type="password"] {
    padding:6px; margin:3px 5px 3px 0; border-radius:6px; border:none; width:150px;
}
.copy-right { margin-top:20px; font-size:0.8rem; color:#ccc; text-align:center; }
#login-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    text-align: center;
}
#login-box {
    background: rgba(255,255,255,0.1);
    padding: 30px 40px;
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    animation: fadeIn 1s ease-in-out;
}
#login-box h2 {
    color: #ffeb3b;
    margin-bottom: 20px;
}
#login-box input {
    width: 200px;
}
#login-box button { margin-top: 10px; }
.login-btn {
    width: 80px; height: 40px;
    font-size: 1rem; font-weight: bold;
    border-radius: 10px;
    background: linear-gradient(90deg,#9C27B0,#BA68C8);
    color: #fff; cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}
.login-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
</style>
</head>
<body>
<div id="login-container">
    <div id="login-box">
        <h2>管理页面</h2>
        <input type="password" id="admin_token" placeholder="管理员令牌"
               onfocus="this.type='text'" onblur="this.type='password'" onkeypress="checkEnter(event)">
        <br>
        <button class="login-btn" onclick="login()"> 登录 </button>
    </div>
</div>
<div class="container" id="main-container" style="display:none;">
    <h1>Nodogsplash 管理面板</h1>
    <div class="info-section">
        <div class="header-flex">
            <h3>客户端列表</h3>
            <div class="client-count" id="client-count">共 0 个客户端</div>
            <div style="margin-left:auto; display:flex; align-items:center;">
                <label for="refresh-interval" style="margin-right:5px;">自动刷新间隔(秒)：</label>
                <input type="number" id="refresh-interval" value="10" min="1" style="width:60px; margin-right:10px;">
                <button class="refresh-btn" id="refresh-btn" onclick="refreshWithSpin()">手动刷新</button>
                <button class="logout-btn" onclick="logout()">注销</button>
            </div>
        </div>

        <div style="margin-top:10px;">
            <label><input type="checkbox" class="status-filter" value="状态" checked> 全部</label>
            <label><input type="checkbox" class="status-filter" value="待认证"> 待认证</label>
            <label><input type="checkbox" class="status-filter" value="已认证"> 已认证</label>
            <label><input type="checkbox" class="status-filter" value="已信任"> 已信任</label>
            <label><input type="checkbox" class="status-filter" value="已阻止"> 已拉黑</label>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th data-sort="id">ID</th>
                        <th>主机名</th>
                        <th data-sort="ip">IP地址</th>
                        <th>MAC地址</th>
                        <th data-sort="download">已下载</th>
                        <th data-sort="upload">已上传</th>
                        <th data-sort="duration">会话时长</th>
                        <th data-sort="expire">上网到期时间</th>
                        <th data-sort="status">状态</th>
                        <th>操作</th>
                        <th>设置上网时长</th>
                    </tr>
                </thead>
                <tbody id="clients-body"></tbody>
            </table>
        </div>
    </div>
    <div class="copy-right">
        版权所有 &copy; Nodogsplash 贡献者 2004-2025。<br>
        本软件依据 GNU GPL 许可证发布。
    </div>
</div>

<script>
function getToken(){return document.getElementById('admin_token').value||localStorage.getItem('admin_token')||'';}
document.getElementById('admin_token').addEventListener('input',e=>{localStorage.setItem('admin_token',e.target.value);});
function checkEnter(e){if(e.key==='Enter'){login();}}
let refreshTimer=null;let refreshInterval=10000;let allClientsData={};let currentSort={key:null,asc:true};
function login(){
    const t=getToken();if(!t){alert("请输入管理员令牌");return;}
    fetch('/admin/clients?admin_token='+encodeURIComponent(t))
    .then(r=>{if(!r.ok)throw new Error(r.status);return r.json();})
    .then(d=>{localStorage.setItem('admin_token',t);document.getElementById('login-container').style.display='none';
        document.getElementById('main-container').style.display='block';allClientsData=d;displayClients(d);startAutoRefresh();})
    .catch(e=>alert("令牌错误或无法连接服务器："+e));
}
function startAutoRefresh(){clearInterval(refreshTimer);const v=parseInt(document.getElementById('refresh-interval').value)||10;
refreshInterval=v*1000;refreshTimer=setInterval(loadClients,refreshInterval);}
document.getElementById('refresh-interval').addEventListener('change',()=>startAutoRefresh());
function logout(){localStorage.removeItem('admin_token');document.getElementById('main-container').style.display='none';
document.getElementById('login-container').style.display='flex';document.getElementById('admin_token').value='';clearInterval(refreshTimer);alert("您已退出登录");}
let currentMACMechanism='block';
function refreshWithSpin(){const b=document.getElementById('refresh-btn');b.classList.add('spin');loadClients();setTimeout(()=>b.classList.remove('spin'),1000);}
function loadClients(){const t=localStorage.getItem('admin_token');if(!t)return;
fetch('/admin/clients?admin_token='+encodeURIComponent(t)).then(r=>r.json()).then(d=>{allClientsData=d;displayClients(d);}).catch(e=>console.error(e));}
function formatTime(ts){if(!ts||ts==0)return'-';return new Date(ts*1000).toLocaleString('zh-CN');}
function formatDuration(s){if(!s||s<=0)return'-';const d=Math.floor(s/86400),h=Math.floor(s%86400/3600),m=Math.floor(s%3600/60),sec=s%60;let r='';if(d>0)r+=`${d}天`;
if(h>0||d>0)r+=`${h}时`;if(m>0||h>0||d>0)r+=`${m}分`;r+=`${sec}秒`;return r;}
function displayClients(data){
    const tb=document.getElementById('clients-body');tb.innerHTML='';currentMACMechanism=data["macmechanism"]||'block';
    let cs=data["客户端信息"];const cnt=document.getElementById('client-count');
    if(!cs||Object.keys(cs).length===0){tb.innerHTML='<tr><td colspan="11">没有客户端</td></tr>';cnt.textContent='共 0 个客户端';return;}
    let arr=Object.values(cs);
    const ck=[...document.querySelectorAll('.status-filter:checked')].map(c=>c.value);
    if(!ck.includes("状态"))arr=arr.filter(c=>ck.includes(c["状态"]));
    if(currentSort.key)arr.sort((a,b)=>compare(a,b,currentSort.key,currentSort.asc));
    cnt.textContent=`共 ${arr.length} 个客户端`;
    for(const c of arr){
        const r=tb.insertRow();
        r.insertCell(0).textContent=c["客户端ID"];
        r.insertCell(1).textContent=c["主机名"]||"未知";
        r.insertCell(2).textContent=c["IP地址"];
        r.insertCell(3).textContent=c["MAC地址"];
        r.insertCell(4).textContent=c["已下载"];
        r.insertCell(5).textContent=c["已上传"];
        r.insertCell(6).textContent=formatDuration(c["会话持续时间"]);
        const ex=r.insertCell(7);
        const isA=c["已认证"];
        ex.textContent=isA&&c["会话结束时间"]>0?formatTime(c["会话结束时间"])+' (剩余:'+formatDuration(c["剩余时间"])+')':'无限制';
        r.insertCell(8).textContent=c["状态"];
        const act=r.insertCell(9);let b='';
        b+=isA?`<button class="deauth" onclick="clientAction('deauth','${c["MAC地址"]}')">取消认证</button>`:`<button class="auth" onclick="clientAction('auth','${c["MAC地址"]}')">认证</button>`;
        b+=c["已信任"]?`<button class="cancel-btn" onclick="clientAction('untrust','${c["MAC地址"]}')">取消信任</button>`:`<button class="trust" onclick="clientAction('trust','${c["MAC地址"]}')">信任</button>`;
        if(currentMACMechanism==='allow'){
            b+=!c["已允许"]?`<button class="allow-btn" onclick="clientAction('allow','${c["MAC地址"]}')">允许</button>`:`<button class="cancel-btn" onclick="clientAction('unallow','${c["MAC地址"]}')">取消允许</button>`;
        }
        b+=c["已拉黑"]?`<button class="cancel-btn" onclick="clientAction('unblock','${c["MAC地址"]}')">取消拉黑</button>`:`<button class="block" onclick="clientAction('block','${c["MAC地址"]}')">拉黑</button>`;
        act.innerHTML=b;
        const du=r.insertCell(10);
        du.innerHTML=`<input type="number" id="duration_${c["客户端ID"]}" placeholder="分" style="width:80px">
        <button class="duration-btn" onclick="setDuration('${c["MAC地址"]}',${c["客户端ID"]})">设置</button>`;
    }
}
function parseSize(v){if(!v)return 0;const m=v.match(/([\d.]+)\s*([KMGTP]?)/i);if(!m)return parseFloat(v)||0;
const n=parseFloat(m[1]);const f={B:1,K:1024,M:1048576,G:1073741824,T:1099511627776};return n*(f[m[2].toUpperCase()]||1);}
function ip2num(ip){return ip.split('.').reduce((a,b)=>(a<<8)+(+b),0);}
function compare(a,b,k,asc){let x,y;
switch(k){case'id':x=a["客户端ID"];y=b["客户端ID"];break;
case'ip':x=ip2num(a["IP地址"]);y=ip2num(b["IP地址"]);break;
case'download':x=parseSize(a["已下载"]);y=parseSize(b["已下载"]);break;
case'upload':x=parseSize(a["已上传"]);y=parseSize(b["已上传"]);break;
case'duration':x=a["会话持续时间"];y=b["会话持续时间"];break;
case'expire':x=a["会话结束时间"]||0;y=b["会话结束时间"]||0;break;
case'status':x=a["状态"];y=b["状态"];return asc?x.localeCompare(y):y.localeCompare(x);}
return asc?x-y:y-x;}
document.querySelectorAll('th[data-sort]').forEach(th=>{
    th.addEventListener('click',()=>{const k=th.dataset.sort;if(currentSort.key===k)currentSort.asc=!currentSort.asc;else currentSort={key:k,asc:true};displayClients(allClientsData);});
});
document.querySelectorAll('.status-filter').forEach(cb=>{
    cb.addEventListener('change',()=>{
        const all=document.querySelector('.status-filter[value="状态"]');
        if(cb.value!=="状态"&&cb.checked&&all.checked)all.checked=false;
        if(cb.value==="状态"&&cb.checked)document.querySelectorAll('.status-filter:not([value="状态"])').forEach(o=>o.checked=false);
        displayClients(allClientsData);
    });
});
function clientAction(a,c){const t=localStorage.getItem('admin_token');if(a==='allow'&&currentMACMechanism!=='allow'){alert('配置为block模式');return;}
fetch(`/admin/${a}?admin_token=${encodeURIComponent(t)}&client=${encodeURIComponent(c)}`).then(r=>r.json()).then(d=>{if(d.success){alert('操作成功');loadClients();}else{alert('错误:'+d.error);}}).catch(e=>alert('请求失败:'+e));}
function setDuration(c,id){const val=document.getElementById('duration_'+id).value;if(!val){alert('请输入时长');return;}
const t=localStorage.getItem('admin_token');const s=val*60;
fetch(`/admin/set_duration?admin_token=${encodeURIComponent(t)}&client=${encodeURIComponent(c)}&duration=${s}`)
.then(r=>r.json()).then(d=>{if(d.success){alert('设置成功');loadClients();}else{alert('错误:'+d.error);}}).catch(e=>alert('请求失败:'+e));}
window.onload=function(){const s=localStorage.getItem('admin_token');if(s){document.getElementById('admin_token').value=s;login();}};
</script>
</body>
</html>
